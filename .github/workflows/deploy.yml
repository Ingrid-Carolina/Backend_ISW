name: Deploy Node.js App 2 (Enhanced)
on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # Navigate to your app directory
            cd ~/Backend_ISW

            # Pull latest changes
            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin master

            # Ensure we're on master branch
            git checkout master || echo "âš ï¸  Failed to switch to master branch"

            # Install/update dependencies
            echo "ğŸ“¦ Installing dependencies..."
            npm install

            # Copy environment file
            echo "âš™ï¸  Copying environment file..."
            cp ../env/.env .env

            # Kill existing Node.js process gracefully
            echo "ğŸ›‘ Stopping existing application..."
            if pgrep -f "node index.js" > /dev/null; then
              pkill -f "node index.js"
              echo "Waiting for process to stop..."
              sleep 3
              # Force kill if still running
              pkill -9 -f "node index.js" 2>/dev/null || true
            else
              echo "No existing process found"
            fi

            # Start the application in background
            echo "ğŸš€ Starting application..."
            nohup node index.js > app.log 2>&1 &

            # Wait and verify startup
            sleep 5
            if pgrep -f "node index.js" > /dev/null; then
              echo "âœ… App started successfully!"
              echo "ğŸ“Š Process info:"
              pgrep -f "node index.js" | head -1 | xargs ps -p
              
              # Optional: Add health check
              # echo "ğŸ¥ Running health check..."
              # curl -f http://localhost:3000/health || echo "âš ï¸  Health check failed"
            else
              echo "âŒ Failed to start app. Check logs:"
              tail -20 app.log
              exit 1
            fi

            echo "ğŸ‰ Deployment completed successfully!"
